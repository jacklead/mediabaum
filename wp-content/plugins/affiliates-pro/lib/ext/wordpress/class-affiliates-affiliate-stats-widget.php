<?php
 class Affiliates_Affiliate_Stats_Widget extends WP_Widget { function __construct() { parent::__construct( false, $name = 'Affiliates Affiliate Stats' ); } function widget( $args, $IXAP224 ) { if ( !affiliates_user_is_affiliate() ) { return; } extract( $args ); $IXAP77 = isset( $IXAP224['title'] ) ? apply_filters( 'widget_title', $IXAP224['title'] ) : ''; $IXAP225 = $args['widget_id']; echo $before_widget; if ( !empty( $IXAP77 ) ) { echo $before_title . $IXAP77 . $after_title; } $IXAP226 = '-' . $IXAP225; $IXAP101 = array( 'is_widget' => true ); $IXAP101 = array_merge( $IXAP101, $IXAP224 ); echo $this->render_affiliate_stats( $IXAP101, $IXAP225 ); echo $after_widget; } function update( $IXAP227, $IXAP228 ) { $IXAP229 = $IXAP228; if ( !empty( $IXAP227['title'] ) ) { $IXAP229['title'] = strip_tags( $IXAP227['title'] ); } else { unset( $IXAP229['title'] ); } $IXAP230 = array( 'show_totals_accepted', 'show_totals_pending', 'show_totals_closed', 'show_totals_rejected' ); foreach ( $IXAP230 as $IXAP220 ) { if ( !empty( $IXAP227[$IXAP220] ) ) { $IXAP229[$IXAP220] = true; } else { unset( $IXAP229[$IXAP220] ); } } return $IXAP229; } function form( $IXAP224 ) { $IXAP77 = isset( $IXAP224['title'] ) ? esc_attr( $IXAP224['title'] ) : ''; ?>
		<p>
			<label for="<?php echo $this->get_field_id('title'); ?>"><?php _e( 'Title:', AFFILIATES_PRO_PLUGIN_DOMAIN ); ?></label> 
			<input class="widefat" id="<?php echo $this->get_field_id( 'title' ); ?>" name="<?php echo $this->get_field_name( 'title' ); ?>" type="text" value="<?php echo $IXAP77; ?>" />
		</p>
		<?php
 $IXAP211 = isset( $IXAP224['show_totals_accepted'] ) ? $IXAP224['show_totals_accepted'] : false; echo '<input type="checkbox" ' . ( $IXAP211 ? ' checked="checked" ' : '' ) . ' name="' . $this->get_field_name( 'show_totals_accepted' ) . '" id="' . $this->get_field_id( 'show_totals_accepted' ) . '"/>'; echo '<label for="' . $this->get_field_name( 'show_totals_accepted' ) . '">' . __( 'Show totals for accepted referrals', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>'; echo '<br/>'; $IXAP212 = isset( $IXAP224['show_totals_pending'] ) ? $IXAP224['show_totals_pending'] : false; echo '<input type="checkbox" ' . ( $IXAP212 ? ' checked="checked" ' : '' ) . ' name="' . $this->get_field_name( 'show_totals_pending' ) . '" id="' . $this->get_field_id( 'show_totals_pending' ) . '"/>'; echo '<label for="' . $this->get_field_name( 'show_totals_pending' ) . '">' . __( 'Show totals for pending referrals', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>'; echo '<br/>'; $IXAP213 = isset( $IXAP224['show_totals_closed'] ) ? $IXAP224['show_totals_closed'] : false; echo '<input type="checkbox" ' . ( $IXAP213 ? ' checked="checked" ' : '' ) . ' name="' . $this->get_field_name( 'show_totals_closed' ) . '" id="' . $this->get_field_id( 'show_totals_closed' ) . '"/>'; echo '<label for="' . $this->get_field_name( 'show_totals_closed' ) . '">' . __( 'Show totals for closed referrals', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>'; echo '<br/>'; $IXAP214 = isset( $IXAP224['show_totals_rejected'] ) ? $IXAP224['show_totals_rejected'] : false; echo '<input type="checkbox" ' . ( $IXAP214 ? ' checked="checked" ' : '' ) . ' name="' . $this->get_field_name( 'show_totals_rejected' ) . '" id="' . $this->get_field_id( 'show_totals_rejected' ) . '"/>'; echo '<label for="' . $this->get_field_name( 'show_totals_rejected' ) . '">' . __( 'Show totals for rejected referrals', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>'; } public static function render_affiliate_stats( $IXAP101 = array() ) { global $affiliates_db; $IXAP58 = ''; $IXAP38 = Affiliates_Affiliate_WordPress::get_user_affiliate_id(); if ( $IXAP38 === false ) { return $IXAP58; } wp_enqueue_style( 'affiliates' ); wp_enqueue_style( 'affiliates-pro' ); $IXAP43 = $affiliates_db->get_tablename( 'affiliates' ); $IXAP45 = $affiliates_db->get_tablename( 'referrals' ); $IXAP108 = $affiliates_db->get_tablename( 'hits' ); $IXAP113 = affiliates_get_affiliate_visits( $IXAP38 ); $IXAP110 = affiliates_get_affiliate_hits( $IXAP38 ); $IXAP207 = affiliates_get_affiliate_referrals( $IXAP38 ); if ( $IXAP113 > 0 ) { $IXAP208 = round( $IXAP207 / $IXAP113, I_Affiliates_Stats_Renderer::IXAP209 ); } else { $IXAP208 = 0; } $IXAP58 .= '<div class="visits">' . sprintf( _n( '%d Visit', '%d Visits', $IXAP113, AFFILIATES_PRO_PLUGIN_DOMAIN ), $IXAP113 ) . '</div>'; $IXAP58 .= '<div class="hits">' . sprintf( _n( '%d Hit', '%d Hits', $IXAP110, AFFILIATES_PRO_PLUGIN_DOMAIN ), $IXAP110 ) . '</div>'; $IXAP58 .= '<div class="referrals">' . sprintf( _n( '%d Referral', '%d Referrals', $IXAP207, AFFILIATES_PRO_PLUGIN_DOMAIN ), $IXAP207 ) . '</div>'; $IXAP58 .= '<div class="ratio">' . sprintf( __( '%.3f Ratio', AFFILIATES_PRO_PLUGIN_DOMAIN ), $IXAP208 ) . '</div>'; $IXAP210 = isset( $IXAP101['show_totals'] ) ? ( $IXAP101['show_totals'] !== 'false' ) : true; $IXAP211 = isset( $IXAP101['show_totals_accepted'] ) ? ( $IXAP101['show_totals_accepted'] === true || $IXAP101['show_totals_accepted'] === 'true' ) : false; $IXAP212 = isset( $IXAP101['show_totals_pending'] ) ? ( $IXAP101['show_totals_pending'] === true || $IXAP101['show_totals_pending'] === 'true' ) : false; $IXAP213 = isset( $IXAP101['show_totals_closed'] ) ? ( $IXAP101['show_totals_closed'] === true || $IXAP101['show_totals_closed'] === 'true' ) : false; $IXAP214 = isset( $IXAP101['show_totals_rejected'] ) ? ( $IXAP101['show_totals_rejected'] === true || $IXAP101['show_totals_rejected'] === 'true' ) : false; if ( $IXAP210 && ( $IXAP211 || $IXAP212 || $IXAP213 || $IXAP214 ) ) { $IXAP216 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IXAP45 WHERE affiliate_id = %d AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IXAP38, AFFILIATES_REFERRAL_STATUS_ACCEPTED ); $IXAP217 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IXAP45 WHERE affiliate_id = %d AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IXAP38, AFFILIATES_REFERRAL_STATUS_PENDING ); $IXAP218 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IXAP45 WHERE affiliate_id = %d AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IXAP38, AFFILIATES_REFERRAL_STATUS_CLOSED ); $IXAP219 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IXAP45 WHERE affiliate_id = %d AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IXAP38, AFFILIATES_REFERRAL_STATUS_REJECTED ); $IXAP58 .= '<div class="totals">'; $IXAP58 .= '<table cellpadding="0" cellspacing="0">'; $IXAP58 .= '<thead>'; $IXAP58 .= '<tr>'; $IXAP58 .= "<th scope='col' class='total'>" . __( 'Total', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP58 .= "<th scope='col' class='amount'>" . __( 'Amount', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP58 .= "<th scope='col' class='currency'>" . __( 'Currency', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP58 .= '</tr>'; $IXAP58 .= '</thead>'; $IXAP58 .= '<tbody>'; if ( $IXAP211 ) { if ( count( $IXAP216 ) == 0 ) { $IXAP216[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP216 as $IXAP220 ) { $IXAP58 .= '<tr>'; $IXAP58 .= "<td class='total accepted'>" . __( 'Accepted', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP58 .= "<td class='amount'>$IXAP220->total</td>"; $IXAP58 .= "<td class='currency'>$IXAP220->currency_id</td>"; $IXAP58 .= '</tr>'; } } if ( $IXAP212 ) { if ( count( $IXAP217 ) == 0 ) { $IXAP217[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP217 as $IXAP220 ) { $IXAP58 .= '<tr>'; $IXAP58 .= "<td class='total pending'>" . __( 'Pending', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP58 .= "<td class='amount'>$IXAP220->total</td>"; $IXAP58 .= "<td class='currency'>$IXAP220->currency_id</td>"; $IXAP58 .= '</tr>'; } } if ( $IXAP213 ) { if ( count( $IXAP218 ) == 0 ) { $IXAP218[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP218 as $IXAP220 ) { $IXAP58 .= '<tr>'; $IXAP58 .= "<td class='total closed'>" . __( 'Closed', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP58 .= "<td class='amount'>$IXAP220->total</td>"; $IXAP58 .= "<td class='currency'>$IXAP220->currency_id</td>"; $IXAP58 .= '</tr>'; } } if ( $IXAP214 ) { if ( count( $IXAP219 ) == 0 ) { $IXAP219[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP219 as $IXAP220 ) { $IXAP58 .= '<tr>'; $IXAP58 .= "<td class='total rejected'>" . __( 'Rejected', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP58 .= "<td class='amount'>$IXAP220->total</td>"; $IXAP58 .= "<td class='currency'>$IXAP220->currency_id</td>"; $IXAP58 .= '</tr>'; } } $IXAP58 .= '</tbody>'; $IXAP58 .= '</table>'; $IXAP58 .= '</div>'; } return $IXAP58; } }?>