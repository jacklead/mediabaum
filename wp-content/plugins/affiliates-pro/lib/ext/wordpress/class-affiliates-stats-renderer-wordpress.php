<?php
 class Affiliates_Stats_Renderer_WordPress extends Affiliates_Stats_Renderer { const IXAP174 = 'affiliate-nonce'; const IXAP175 = 'affiliate-nonce-1'; const IXAP176 = 'affiliate-nonce-2'; const IXAP177 = 'affiliate-nonce-filters'; static function init() { add_shortcode( 'affiliates_affiliate_stats', array( 'Affiliates_Stats_Renderer_WordPress', 'stats_shortcode' ) ); } static function stats_shortcode( $IXAP205, $IXAP156 = null ) { $IXAP15 = null; wp_enqueue_script( 'datepicker' ); wp_enqueue_script( 'datepickers' ); wp_enqueue_style( 'smoothness' ); wp_enqueue_style( 'affiliates-pro' ); $IXAP101 = shortcode_atts( self::$IXAP172, $IXAP205 ); switch ( $IXAP101['type'] ) { case self::IXAP206 : $IXAP15 = Affiliates_Affiliate_Stats_Renderer_WordPress::render_referrals( $IXAP101 ); break; case self::IXAP173 : $IXAP15 = self::render_affiliate_stats( $IXAP101 ); break; } return $IXAP15; } static function render_affiliate_stats( $IXAP101 = array() ) { global $affiliates_options, $affiliates_db; $IXAP58 = ''; $IXAP38 = Affiliates_Affiliate_WordPress::get_user_affiliate_id(); if ( $IXAP38 === false ) { return $IXAP58; } $IXAP31 = $affiliates_options->get_option( 'affiliate_stats_from_date', null ); $IXAP33 = $affiliates_options->get_option( 'affiliate_stats_thru_date', null ); if ( isset( $_POST[self::IXAP177] ) ) { if ( !wp_verify_nonce( $_POST[self::IXAP177], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( isset( $_POST['clear_filters'] ) ) { $affiliates_options->delete_option( 'affiliate_stats_from_date' ); $affiliates_options->delete_option( 'affiliate_stats_thru_date' ); $IXAP31 = null; $IXAP33 = null; } else { if ( !empty( $_POST['from_date'] ) ) { $IXAP31 = date( 'Y-m-d', strtotime( $_POST['from_date'] ) ); $affiliates_options->update_option( 'affiliate_stats_from_date', $IXAP31 ); } if ( !empty( $_POST['thru_date'] ) ) { $IXAP33 = date( 'Y-m-d', strtotime( $_POST['thru_date'] ) ); $affiliates_options->update_option( 'affiliate_stats_thru_date', $IXAP33 ); } if ( $IXAP31 && $IXAP33 ) { if ( strtotime( $IXAP31 ) > strtotime( $IXAP33 ) ) { $IXAP33 = null; $affiliates_options->delete_option( 'affiliate_stats_thru_date' ); } } } } if ( $IXAP31 ) { $IXAP32 = DateHelper::u2s( $IXAP31 ); } if ( $IXAP33 ) { $IXAP34 = DateHelper::u2s( $IXAP33, 24*3600 ); } $IXAP43 = $affiliates_db->get_tablename( 'affiliates' ); $IXAP45 = $affiliates_db->get_tablename( 'referrals' ); $IXAP108 = $affiliates_db->get_tablename( 'hits' ); if ( $IXAP31 || $IXAP33 || $IXAP38 ) { $IXAP47 = " WHERE "; } else { $IXAP47 = ''; } $IXAP48 = array(); if ( $IXAP31 && $IXAP33 ) { $IXAP47 .= " datetime >= %s AND datetime < %s "; $IXAP48[] = $IXAP32; $IXAP48[] = $IXAP34; } else if ( $IXAP31 ) { $IXAP47 .= " datetime >= %s "; $IXAP48[] = $IXAP32; } else if ( $IXAP33 ) { $IXAP47 .= " datetime < %s "; $IXAP48[] = $IXAP34; } if ( $IXAP38 ) { if ( $IXAP31 || $IXAP33 ) { $IXAP47 .= " AND "; } $IXAP47 .= " h.affiliate_id = %d "; $IXAP48[] = $IXAP38; } $IXAP72 = array( 'visits' => __( 'Visits', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'hits' => __( 'Hits', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'referrals' => __( 'Referrals', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'ratio' => __( 'Ratio', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); $IXAP113 = affiliates_get_affiliate_visits( $IXAP38, $IXAP31, $IXAP33 ); $IXAP110 = affiliates_get_affiliate_hits( $IXAP38, $IXAP31, $IXAP33 ); $IXAP207 = affiliates_get_affiliate_referrals( $IXAP38, $IXAP31, $IXAP33 ); if ( $IXAP113 > 0 ) { $IXAP208 = round( $IXAP207 / $IXAP113, self::IXAP209 ); } else { $IXAP208 = 0; } $IXAP58 .= '<div id="" class="affiliate-stats summary">'; $IXAP58 .= '
			<table class="wp-list-table widefat fixed" cellspacing="0">
			<thead>
				<tr>
				'; foreach ( $IXAP72 as $IXAP74 => $IXAP75 ) { $IXAP58 .= "<th scope='col' class='$IXAP74'>$IXAP75</th>"; } $IXAP58 .= '</tr>
			</thead>
			<tbody>
			'; $IXAP58 .= '<tr>'; $IXAP58 .= "<td class='visits'>$IXAP113</td>"; $IXAP58 .= "<td class='hits'>$IXAP110</td>"; $IXAP58 .= "<td class='referrals'>$IXAP207</td>"; $IXAP58 .= "<td class='ratio'>$IXAP208</td>"; $IXAP58 .= '</tr>'; $IXAP58 .= '</tbody>'; $IXAP58 .= '</table>'; $IXAP210 = isset( $IXAP101['show_totals'] ) ? ( $IXAP101['show_totals'] !== 'false' ) : true; $IXAP211 = isset( $IXAP101['show_totals_accepted'] ) ? ( $IXAP101['show_totals_accepted'] === true || $IXAP101['show_totals_accepted'] === 'true' ) : false; $IXAP212 = isset( $IXAP101['show_totals_pending'] ) ? ( $IXAP101['show_totals_pending'] === true || $IXAP101['show_totals_pending'] === 'true' ) : false; $IXAP213 = isset( $IXAP101['show_totals_closed'] ) ? ( $IXAP101['show_totals_closed'] === true || $IXAP101['show_totals_closed'] === 'true' ) : false; $IXAP214 = isset( $IXAP101['show_totals_rejected'] ) ? ( $IXAP101['show_totals_rejected'] === true || $IXAP101['show_totals_rejected'] === 'true' ) : false; if ( $IXAP210 && ( $IXAP211 || $IXAP212 || $IXAP213 || $IXAP214 ) ) { $IXAP215 = ''; if ( $IXAP31 && $IXAP33 ) { $IXAP215 = " AND datetime >= '$IXAP32' AND datetime < '$IXAP34' "; } else if ( $IXAP31 ) { $IXAP215 = " AND datetime >= '$IXAP32' "; } else if ( $IXAP33 ) { $IXAP215 = " AND datetime < '$IXAP34' "; } $IXAP216 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IXAP45 WHERE affiliate_id = %d $IXAP215 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IXAP38, AFFILIATES_REFERRAL_STATUS_ACCEPTED ); $IXAP217 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IXAP45 WHERE affiliate_id = %d $IXAP215 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IXAP38, AFFILIATES_REFERRAL_STATUS_PENDING ); $IXAP218 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IXAP45 WHERE affiliate_id = %d $IXAP215 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IXAP38, AFFILIATES_REFERRAL_STATUS_CLOSED ); $IXAP219 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IXAP45 WHERE affiliate_id = %d $IXAP215 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IXAP38, AFFILIATES_REFERRAL_STATUS_REJECTED ); $IXAP58 .= '<table class="wp-list-table widefat fixed" cellspacing="0">'; $IXAP58 .= '<thead>'; $IXAP58 .= '<tr>'; $IXAP58 .= "<th scope='col' class='total'>" . __( 'Total', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP58 .= "<th scope='col' class='amount'>" . __( 'Amount', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP58 .= "<th scope='col' class='currency'>" . __( 'Currency', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP58 .= '</tr>'; $IXAP58 .= '</thead>'; $IXAP58 .= '<tbody>'; if ( $IXAP211 ) { if ( count( $IXAP216 ) == 0 ) { $IXAP216[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP216 as $IXAP220 ) { $IXAP58 .= '<tr>'; $IXAP58 .= "<td class='total accepted'>" . __( 'Accepted', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP58 .= "<td class='amount'>$IXAP220->total</td>"; $IXAP58 .= "<td class='currency'>$IXAP220->currency_id</td>"; $IXAP58 .= '</tr>'; } } if ( $IXAP212 ) { if ( count( $IXAP217 ) == 0 ) { $IXAP217[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP217 as $IXAP220 ) { $IXAP58 .= '<tr>'; $IXAP58 .= "<td class='total pending'>" . __( 'Pending', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP58 .= "<td class='amount'>$IXAP220->total</td>"; $IXAP58 .= "<td class='currency'>$IXAP220->currency_id</td>"; $IXAP58 .= '</tr>'; } } if ( $IXAP213 ) { if ( count( $IXAP218 ) == 0 ) { $IXAP218[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP218 as $IXAP220 ) { $IXAP58 .= '<tr>'; $IXAP58 .= "<td class='total closed'>" . __( 'Closed', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP58 .= "<td class='amount'>$IXAP220->total</td>"; $IXAP58 .= "<td class='currency'>$IXAP220->currency_id</td>"; $IXAP58 .= '</tr>'; } } if ( $IXAP214 ) { if ( count( $IXAP219 ) == 0 ) { $IXAP219[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP219 as $IXAP220 ) { $IXAP58 .= '<tr>'; $IXAP58 .= "<td class='total rejected'>" . __( 'Rejected', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP58 .= "<td class='amount'>$IXAP220->total</td>"; $IXAP58 .= "<td class='currency'>$IXAP220->currency_id</td>"; $IXAP58 .= '</tr>'; } } $IXAP58 .= '</tbody>'; $IXAP58 .= '</table>'; } $IXAP58 .= '<div class="filters">' . '<label class="description" for="setfilters">' . __( 'Filters', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<form id="setfilters" action="" method="post">' . '<div class="from-date">' . '<label class="from-date-filter" for="from_date">' . __('From', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<noscript><span class="description mini">' . __( 'Format: YYYY-MM-DD', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</span></noscript>' . '<input class="datefield from-date-filter" name="from_date" type="text" value="' . esc_attr( $IXAP31 ) . '"/>'. '</div>' . '<div class="thru-date">' . '<label class="thru-date-filter" for="thru_date">' . __('Until', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<noscript><span class="description mini">' . __( 'Format: YYYY-MM-DD', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</span></noscript>' . '<input class="datefield thru-date-filter" name="thru_date" type="text" class="datefield" value="' . esc_attr( $IXAP33 ) . '"/>'. '</div>' . '<div class="submit">' . wp_nonce_field( plugin_basename( __FILE__ ), self::IXAP177, true, false ) . '<input type="submit" value="' . __( 'Apply', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="submit" name="clear_filters" value="' . __( 'Clear', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="submitted" name="submitted"/>' . '</div>' . '</form>' . '</div>'; $IXAP58 .= '</div>'; return $IXAP58; } } Affiliates_Stats_Renderer_WordPress::init();