<?php
class Affiliates_Referral_WordPress extends Affiliates_Referral { public function suggest( $post_id, $IXAP231 = '', $IXAP203 = null, $IXAP23 = null, $IXAP37 = null, $IXAP232 = null ) { trigger_error( __FUNCTION__ . " is deprecated", E_USER_WARNING ); return $this->evaluate( $post_id, $IXAP231, $IXAP203, null, $IXAP23, $IXAP37, $IXAP232 ); } public function evaluate( $post_id, $IXAP231 = '', $IXAP203 = null, $IXAP233 = null, $IXAP23 = null, $IXAP37 = null, $IXAP232 = null, $IXAP234 = null, $IXAP235 = null, $IXAP236 = false ) { require_once( AFFILIATES_CORE_LIB . '/class-affiliates-service.php' ); $IXAP38 = Affiliates_Service::get_referrer_id(); if ( !$IXAP236 ) { if ( $IXAP38 ) { $IXAP237 = array ( $IXAP38 ); $this->add_referrals( $IXAP237, $post_id, $IXAP231, $IXAP203, $IXAP233, $IXAP23, $IXAP37, $IXAP232, $IXAP234, $IXAP235 ); } } return $IXAP38; } public function suggest_by_attribute( $IXAP238, $IXAP239, $post_id, $IXAP231 = '', $IXAP203 = null, $IXAP233 = null, $IXAP23 = null, $IXAP37 = null, $IXAP232 = null, $IXAP234 = null, $IXAP235 = null, $IXAP236 = false ) { global $wpdb, $affiliates_options; global $affiliates_db; bcscale( AFFILIATES_REFERRAL_AMOUNT_DECIMALS ); $IXAP43 = $affiliates_db->get_tablename( "affiliates" ); $IXAP94 = $affiliates_db->get_tablename( "affiliates_attributes" ); $IXAP52 = date( 'Y-m-d H:i:s', time() ); $IXAP97 = date( 'Y-m-d', time() ); $IXAP237 = $affiliates_db->get_objects( "SELECT a.affiliate_id FROM $IXAP43 a
			LEFT JOIN $IXAP94 aa ON a.affiliate_id = aa.affiliate_id
			WHERE
			aa.attr_key = %s
			AND aa.attr_value = %s
			AND a.from_date <= %s AND ( a.thru_date IS NULL OR a.thru_date >= %s )
			AND a.status = 'active'
			", $IXAP238, $IXAP239, $IXAP97, $IXAP97 ); if ( empty( $IXAP237 ) ) { if ( get_option( 'aff_use_direct', true ) ) { $IXAP237 = array ( (object) array( 'affiliate_id' => affiliates_get_direct_id() ) ); } } if ( !$IXAP236 ) { $IXAP240 = array(); foreach ( $IXAP237 as $IXAP38 ) { $IXAP240[] = $IXAP38->affiliate_id; } $this->add_referrals( $IXAP240, $post_id, $IXAP231, $IXAP203, $IXAP233, $IXAP23, $IXAP37, $IXAP232, $IXAP234, $IXAP235, $IXAP236 ); } return $IXAP237; } public function add_referrals( $IXAP237, $post_id, $IXAP231 = '', $IXAP203 = null, $IXAP233 = null, $IXAP23 = null, $IXAP37 = null, $IXAP232 = null, $IXAP234 = null, $IXAP235 = null, $IXAP236 = false ) { global $affiliates_db; $IXAP43 = $affiliates_db->get_tablename( "affiliates" ); $IXAP94 = $affiliates_db->get_tablename( "affiliates_attributes" ); $IXAP52 = date( 'Y-m-d H:i:s', time() ); $IXAP97 = date( 'Y-m-d', time() ); bcscale( AFFILIATES_REFERRAL_AMOUNT_DECIMALS ); if ( !empty( $IXAP237 ) ) { foreach ( $IXAP237 as $IXAP38 ) { $IXAP241 = wp_get_current_user(); $IXAP52 = date('Y-m-d H:i:s', time() ); $IXAP242 = $affiliates_db->get_tablename( 'referrals' ); $IXAP243 = "(affiliate_id, post_id, datetime, description"; $IXAP244 = "(%d, %d, %s, %s"; $IXAP86 = array($IXAP38, $post_id, $IXAP52, $IXAP231); if ( !empty( $IXAP241 ) ) { $IXAP243 .= ",user_id "; $IXAP244 .= ",%d "; $IXAP86[] = $IXAP241->ID; } $IXAP245 = $_SERVER['REMOTE_ADDR']; if ( PHP_INT_SIZE >= 8 ) { if ( $IXAP246 = ip2long( $IXAP245 ) ) { $IXAP243 .= ',ip '; $IXAP244 .= ',%d '; $IXAP86[] = $IXAP246; } } else { if ( $IXAP246 = ip2long( $IXAP245 ) ) { $IXAP246 = sprintf( '%u', $IXAP246 ); $IXAP243 .= ',ip'; $IXAP244 .= ',%s'; $IXAP86[] = $IXAP246; } } if ( !empty( $IXAP37 ) ) { if ( empty( $IXAP23 ) ) { $IXAP247 = $affiliates_db->get_objects( "SELECT * FROM $IXAP94
								WHERE
								affiliate_id = %d
								AND attr_key IN ('referral.rate','referral.rate.method','referral.amount','referral.amount.method')
								", $IXAP38 ); $IXAP248 = null; $IXAP249 = null; $IXAP250 = null; foreach( $IXAP247 as $IXAP251 ) { switch( $IXAP251->attr_key ) { case 'referral.amount' : $IXAP248 = bcadd( "0", $IXAP251->attr_value ); break; case 'referral.amount.method' : $IXAP249 = bcadd( "0", call_user_func( Affiliates_Referral::get_referral_amount_method( $IXAP251->attr_value ), $IXAP38, array( "affiliate_ids" => $IXAP237, "post_id" => $post_id, "description" => $IXAP231, "data" => $IXAP203, "base_amount" => $IXAP233, "amount" => $IXAP23, "currency_id" => $IXAP37, "status" => $IXAP232, "type" => $IXAP234, "reference" => $IXAP235, "test" => $IXAP236 ) ) ); break; case 'referral.rate' : $IXAP250 = bcmul( $IXAP233, $IXAP251->attr_value ); break; } } if ( $IXAP248 ) { $IXAP23 = $IXAP248; } else if ( $IXAP249 ) { $IXAP23 = $IXAP249; } else if ( $IXAP250 ) { $IXAP23 = $IXAP250; } else { if ( $IXAP252 = Affiliates_Attributes::validate_key( get_option( self::IXAP13, null ) ) ) { if ( $IXAP253 = Affiliates_Attributes::validate_value( $IXAP252, get_option( self::IXAP14, null ) ) ) { switch ( $IXAP252 ) { case 'referral.amount' : $IXAP23 = bcadd( "0", $IXAP253 ); break; case 'referral.amount.method' : $IXAP23 = bcadd( "0", call_user_func( Affiliates_Referral::get_referral_amount_method( $IXAP253 ), $IXAP38, array( "affiliate_ids" => $IXAP237, "post_id" => $post_id, "description" => $IXAP231, "data" => $IXAP203, "base_amount" => $IXAP233, "amount" => $IXAP23, "currency_id" => $IXAP37, "status" => $IXAP232, "type" => $IXAP234, "reference" => $IXAP235, "test" => $IXAP236 ) ) ); break; case 'referral.rate' : $IXAP23 = bcmul( $IXAP233, $IXAP253 ); break; } } } } } if ( !empty( $IXAP23 ) ) { if ( $IXAP23 = Affiliates_Utility::verify_referral_amount( $IXAP23 ) ) { if ( $IXAP37 = Affiliates_Utility::verify_currency_id( $IXAP37 ) ) { $IXAP243 .= ",amount "; $IXAP244 .= ",%s "; $IXAP86[] = $IXAP23; $IXAP243 .= ",currency_id "; $IXAP244 .= ",%s "; $IXAP86[] = $IXAP37; } } } } if ( is_array( $IXAP203 ) && !empty( $IXAP203 ) ) { $IXAP243 .= ",data "; $IXAP244 .= ",%s "; $IXAP86[] = serialize( $IXAP203 ); } if ( !empty( $IXAP232 ) && Affiliates_Utility::verify_referral_status_transition( $IXAP232, $IXAP232 ) ) { $IXAP243 .= ',status '; $IXAP244 .= ',%s '; $IXAP86[] = $IXAP232; } else { $IXAP243 .= ',status '; $IXAP244 .= ',%s '; $IXAP86[] = get_option( 'aff_default_referral_status', AFFILIATES_REFERRAL_STATUS_ACCEPTED ); } if ( !empty( $IXAP234 ) ) { $IXAP243 .= ',type '; $IXAP244 .= ',%s '; $IXAP86[] = $IXAP234; } if ( !empty( $IXAP235 ) ) { $IXAP243 .= ',reference '; $IXAP244 .= ',%s '; $IXAP86[] = $IXAP235; } $IXAP243 .= ")"; $IXAP244 .= ")"; if ( !$IXAP236 ) { $IXAP254 = explode( ',', str_replace( ' ', '', substr( $IXAP243, 1, strlen( $IXAP243 ) - 2 ) ) ); $IXAP255 = array_combine( $IXAP254, $IXAP86 ); $IXAP256 = apply_filters( 'affiliates_record_referral', true, $IXAP255 ); if ( $IXAP256 ) { if ( !affiliates_is_duplicate_referral( array( 'affiliate_id' => $IXAP38, 'amount' => $IXAP23, 'currency_id' => $IXAP37, 'type' => $IXAP234, 'reference' => $IXAP235, 'data' => $IXAP203 ) ) ) { if ( $affiliates_db->query( "INSERT INTO $IXAP242 $IXAP243 VALUES $IXAP244", $IXAP86 ) !== false ) { if ( $IXAP257 = $affiliates_db->get_value( "SELECT LAST_INSERT_ID()" ) ) { do_action( 'affiliates_referral', $IXAP257, array( 'affiliate_id' => $IXAP38, 'post_id' => $post_id, 'description' => $IXAP231, 'data' => $IXAP203, 'base_amount' => $IXAP233, 'amount' => $IXAP23, 'currency_id' => $IXAP37, 'status' => $IXAP232, 'type' => $IXAP234, 'reference' => $IXAP235, 'test' => $IXAP236 ) ); } } } } } } } return $IXAP237; } public function __construct( $IXAP257 = null ) { if ( $IXAP257 !== null ) { global $affiliates_db; $IXAP45 = $affiliates_db->get_tablename( 'referrals' ); if ( $IXAP207 = $affiliates_db->get_objects( "SELECT * FROM $IXAP45 WHERE referral_id = %d", $IXAP257 ) ) { if ( count( $IXAP207 ) > 0 ) { $this->referral = $IXAP207[0]; } } if ( $this->referral === null ) { throw new Exception(); } } } public function update( $IXAP258 ) { global $affiliates_db; $IXAP15 = null; if ( $this->referral !== null ) { $IXAP259 = array(); $IXAP254 = array(); $IXAP86 = array(); $IXAP260 = array(); foreach( $IXAP258 as $IXAP74 => $IXAP83 ) { $IXAP261 = isset( $this->referral->$IXAP74 ) ? $this->referral->$IXAP74 : null; if ( $IXAP261 !== $IXAP83 ) { switch( $IXAP74 ) { case 'affiliate_id' : case 'post_id' : $IXAP259[] = " $IXAP74 = %d "; $IXAP254[] = $IXAP74; $IXAP86[] = intval( $IXAP83 ); $IXAP260[] = $IXAP261; break; case 'datetime' : case 'description' : case 'reference' : $IXAP259[] = " $IXAP74 = %s "; $IXAP254[] = $IXAP74; $IXAP86[] = $IXAP83; $IXAP260[] = $IXAP261; break; case 'status' : if ( !empty( $IXAP83 ) && Affiliates_Utility::verify_referral_status_transition( $IXAP83, $IXAP83 ) ) { $IXAP259[] = " $IXAP74 = %s "; $IXAP254[] = $IXAP74; $IXAP86[] = $IXAP83; $IXAP260[] = $IXAP261; } break; case 'amount' : if ( $IXAP83 = Affiliates_Utility::verify_referral_amount( $IXAP83 ) ) { $IXAP259[] = " $IXAP74 = %s "; $IXAP254[] = $IXAP74; $IXAP86[] = $IXAP83; $IXAP260[] = $IXAP261; } break; case 'currency_id' : if ( $IXAP83 = Affiliates_Utility::verify_currency_id( $IXAP83 ) ) { $IXAP259[] = " $IXAP74 = %s "; $IXAP254[] = $IXAP74; $IXAP86[] = $IXAP83; $IXAP260[] = $IXAP261; } break; } } } if ( count( $IXAP259 ) > 0 ) { $IXAP259 = implode( ' , ', $IXAP259 ); $IXAP45 = $affiliates_db->get_tablename( 'referrals' ); if ( $affiliates_db->query( "UPDATE $IXAP45 SET $IXAP259 WHERE referral_id = %d", array_merge( $IXAP86, array( intval( $this->referral->referral_id ) ) ) ) ) { if ( $IXAP207 = $affiliates_db->get_objects( "SELECT * FROM $IXAP45 WHERE referral_id = %d", intval( $this->referral->referral_id ) ) ) { if ( count( $IXAP207 ) > 0 ) { $this->referral = $IXAP207[0]; } } $IXAP15 = array( 'keys' => $IXAP254, 'values' => $IXAP86, 'old_values' => $IXAP260 ); do_action( 'affiliates_updated_referral', intval( $this->referral->referral_id ), $IXAP254, $IXAP86, $IXAP260 ); } } } return $IXAP15; } }