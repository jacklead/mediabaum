<?php
class Affiliates_Attributes_WordPress extends Affiliates_Attributes { function view( $IXAP38 ) { global $wpdb, $affiliates_options, $affiliates_db; $IXAP58 = ''; $IXAP327 = new Affiliates_Affiliate_WordPress(); $IXAP328 = $IXAP327->get_affiliate( $IXAP38 ); if ( $IXAP328 ) { $IXAP66 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP66 = remove_query_arg( 'action', $IXAP66 ); $IXAP66 = remove_query_arg( 'affiliate_id', $IXAP66 ); $IXAP178 = isset( $_POST['row_count'] ) ? intval( $_POST['row_count'] ) : 0; if ($IXAP178 <= 0) { $IXAP178 = $affiliates_options->get_option( 'affiliates_attributes_per_page', AFFILIATES_HITS_PER_PAGE ); } else { $affiliates_options->update_option('affiliates_attributes_per_page', $IXAP178 ); } $IXAP180 = isset( $_GET['offset'] ) ? intval( $_GET['offset'] ) : 0; if ( $IXAP180 < 0 ) { $IXAP180 = 0; } $IXAP181 = isset( $_GET['paged'] ) ? intval( $_GET['paged'] ) : 0; if ( $IXAP181 < 0 ) { $IXAP181 = 0; } $IXAP58 .= '<div class="manage-affiliates">' . '<div>' . '<h2>' . __( 'Affiliate Attributes', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h2>' . '</div>'; $IXAP58 .= '<div class="manage">' . "<a title='" . __( 'Click to add a new attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "' class='add' href='" . esc_url( $IXAP66 ) . "&action=add-attribute&affiliate_id=" . urlencode( $IXAP38 ) . "'><img class='icon' alt='" . __( 'Add', AFFILIATES_PRO_PLUGIN_DOMAIN) . "' src='". AFFILIATES_PRO_PLUGIN_URL ."images/add.png'/><span class='label'>" . __( 'New Attribute', AFFILIATES_PRO_PLUGIN_DOMAIN) . "</span></a>" . '</div>'; $IXAP58 .= '<div class="affiliates-attributes-overview">'; $IXAP72 = array( 'attr_key' => __( 'Id', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'attr_value' => __( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'edit' => __( 'Edit', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'remove' => __( 'Remove', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); $IXAP58 .= '
				<table id="" class="wp-list-table widefat fixed" cellspacing="0">
				<thead>
					<tr>
					'; foreach ( $IXAP72 as $IXAP74 => $IXAP75 ) { $IXAP58 .= "<th scope='col' class='$IXAP74'>$IXAP75</th>"; } $IXAP58 .= '</tr>
				</thead>
				<tbody>
				'; $IXAP94 = $affiliates_db->get_tablename( "affiliates_attributes" ); $IXAP205 = $affiliates_db->get_objects("SELECT * FROM $IXAP94 WHERE affiliate_id = %d", $IXAP38 ); if ( !empty( $IXAP205 ) ) { $IXAP254 = Affiliates_Attributes::get_keys(); $IXAP76 = 0; foreach ( $IXAP205 as $IXAP329 ) { $IXAP276 = ''; $IXAP278 = ''; $IXAP58 .= '<tr class="' . $IXAP276 . $IXAP278 . ( $IXAP76 % 2 == 0 ? 'even' : 'odd' ) . '">'; $IXAP58 .= '<td>' . wp_filter_kses( $IXAP254[$IXAP329->attr_key] ) . '</td>'; $IXAP330 = @unserialize( $IXAP329->attr_value ); if ( $IXAP330 !== false ) { $IXAP83 = $IXAP330; } else { $IXAP83 = $IXAP329->attr_value; } if ( is_array( $IXAP83 ) ) { $IXAP83 = implode( "::", $IXAP83 ); } $IXAP58 .= '<td>' . wp_filter_kses( $IXAP83 ) . '</td>'; $IXAP58 .= "<td class='edit'><a href='" . esc_url( $IXAP66 ) . "&action=edit-attribute&affiliate_id=" . urlencode( $IXAP38 ) . "&attr_key=" . urlencode( $IXAP329->attr_key ) . "' alt='" . __( 'Edit', AFFILIATES_PRO_PLUGIN_DOMAIN) . "'><img src='". AFFILIATES_PRO_PLUGIN_URL ."images/edit.png'/></a></td>"; $IXAP58 .= "<td class='remove'><a href='" . esc_url( $IXAP66 ) . "&action=remove-attribute&affiliate_id=" . urlencode( $IXAP38 ) . "&attr_key=" . urlencode( $IXAP329->attr_key ) . "' alt='" . __( 'Remove', AFFILIATES_PRO_PLUGIN_DOMAIN) . "'><img src='". AFFILIATES_PRO_PLUGIN_URL ."images/remove.png'/></a></td>"; $IXAP58 .= '</tr>'; $IXAP76++; } $IXAP58 .= '</table>'; $IXAP58 .= '</td>'; $IXAP58 .= '</tr>'; } else { $IXAP58 .= '<tr><td colspan="' . count( $IXAP72 ) . '">' . __('There are no results.', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</td></tr>'; } $IXAP58 .= '</tbody>'; $IXAP58 .= '</table>'; $IXAP58 .= '</div>'; $IXAP58 .= '</div>'; } echo $IXAP58; } function add( $IXAP38 ) { global $affiliates_db; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } affiliates_pro_admin_notices(); $IXAP66 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP66 = remove_query_arg( 'action', $IXAP66 ); $IXAP66 = remove_query_arg( 'affiliate_id', $IXAP66 ); $IXAP331 = esc_url( $IXAP66 ) . "&action=edit&affiliate_id=" . urlencode( $IXAP38 ); $IXAP66 = remove_query_arg( 'paged', $IXAP66 ); $IXAP38 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : $IXAP38; $IXAP332 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : ''; $IXAP333 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : ''; $IXAP334 = array(); $IXAP94 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP335 = $affiliates_db->get_objects( "SELECT * FROM $IXAP94 WHERE affiliate_id = %d", $IXAP38 ); foreach( $IXAP335 as $IXAP336 ) { $IXAP334[] = $IXAP336->attr_key; } $IXAP337 = '<select id="attr-key-field" name="attr-key-field" class="attr-key-field">'; $IXAP254 = Affiliates_Attributes::get_keys(); foreach( $IXAP254 as $IXAP74 => $name ) { if ( !in_array( $IXAP74, $IXAP334 ) ) { $IXAP272 = $IXAP332 == $IXAP74 ? ' selected="selected" ' : ''; $IXAP337 .= '<option value="' . esc_attr( $IXAP74 ) . '" ' . $IXAP272 . '>' . wp_filter_kses( $name ) . '</option>'; } } $IXAP337 .= '</select>'; $IXAP58 = '<div class="manage-affiliates">' . '<div>' . '<h2>' . __( 'Add a new attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h2>' . '</div>' . '<form id="add-attribute" action="' . $IXAP66 . '" method="post">' . '<div class="affiliate new">' . '<div class="field">' . '<label for="attr-key-field" class="field-label first required">' .__( 'Key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . $IXAP337 . '</div>' . '<div class="field">' . '<label for="attr-value-field" class="field-label first required">' .__( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input id="attr-value-field" name="attr-value-field" class="attr-value-field" type="text" value="' . esc_attr( $IXAP333 ) . '"/>' . '</div>' . '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button" type="submit" value="' . __( 'Add', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="' . esc_attr( $IXAP38 ) . '" name="affiliate_id"/>' . '<input type="hidden" value="add-attribute" name="action"/>' . '<a class="cancel" href="' . $IXAP331 . '">' . __( 'Cancel', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IXAP58; } function add_submit() { global $wpdb, $affiliates_db, $IXAP1; $IXAP15 = true; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP94 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP38 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : null; $IXAP332 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : null; $IXAP333 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : null; if ( $IXAP333 !== null ) { $IXAP333 = Affiliates_Attributes::validate_value( $IXAP332, $IXAP333 ); if ( $IXAP333 !== false ) { if ( is_array( $IXAP333 ) || is_object( $IXAP333 ) ) { $IXAP333 = serialize( $IXAP333 ); } } else { $IXAP333 = null; } } $IXAP338 = false; if ( ( $IXAP332 == Affiliates_Attributes::IXAP82 ) && !empty( $IXAP333 ) ) { $IXAP339 = explode( ",", $IXAP333 ); foreach( $IXAP339 as $IXAP340 ) { $IXAP340 = trim( $IXAP340 ); $IXAP341 = self::get_affiliate_for_coupon( $IXAP340 ); if ( ( $IXAP341 !== null ) && ( $IXAP341 != $IXAP38 ) ) { $IXAP1[] = '<div class="error">' . sprintf( __( 'Coupons may not be assigned to multiple affiliates. The coupon code <strong>%s</strong> has already been assigned to the affiliate with Id %d.', AFFILIATES_PRO_PLUGIN_DOMAIN), $IXAP340, $IXAP341 ) . '</div>'; $IXAP338 = true; } } } if ( $IXAP338 ) { return false; } if ( !empty( $IXAP38 ) && Affiliates_Attributes::validate_key( $IXAP332 ) && ( $IXAP333 !== null ) ) { if ( !$affiliates_db->get_value( "SELECT * FROM $IXAP94 WHERE affiliate_id = %d AND attr_key = %s", $IXAP38, $IXAP332 ) ) { if ( $affiliates_db->query( "INSERT INTO $IXAP94 SET affiliate_id=%d, attr_key=%s, attr_value=%s", $IXAP38, $IXAP332, $IXAP333 ) ) { do_action( 'affiliates_added_attribute', $IXAP38, $IXAP332, $IXAP333 ); } } else { $IXAP1[] = '<div class="error">' . __( 'Duplicate key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP15 = false; } } else { $IXAP1[] = '<div class="error">' . __( 'Invalid data', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP15 = false; } return $IXAP15; } function edit( $IXAP38, $IXAP332 ) { global $affiliates_db; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } affiliates_pro_admin_notices(); $IXAP66 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP66 = remove_query_arg( 'action', $IXAP66 ); $IXAP66 = remove_query_arg( 'affiliate_id', $IXAP66 ); $IXAP331 = esc_url( $IXAP66 ) . "&action=edit&affiliate_id=" . urlencode( $IXAP38 ); $IXAP66 = remove_query_arg( 'paged', $IXAP66 ); $IXAP94 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP333 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP94 WHERE affiliate_id = %d AND attr_key = %s", $IXAP38, $IXAP332 ); $IXAP38 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : $IXAP38; $IXAP332 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : $IXAP332; $IXAP333 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : $IXAP333; $IXAP342 = @unserialize( $IXAP333 ); if ( $IXAP342 === false ) { $IXAP342 = $IXAP333; } if ( is_array( $IXAP342 ) ) { $IXAP342 = implode( "::", $IXAP342 ); } $IXAP254 = Affiliates_Attributes::get_keys(); $IXAP58 = '<div class="manage-affiliates">' . '<div>' . '<h2>' . __( 'Edit an attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h2>' . '</div>' . '<form id="edit-attribute" action="' . $IXAP66 . '" method="post">' . '<div class="affiliate-attribute edit">' . '<div class="field">' . '<label for="attr-key-field" class="field-label first required">' .__( 'Key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input readonly="readonly" id="attr-name-field" name="attr-name-field" class="attr-name-field" type="text" value="' . esc_attr( $IXAP254[$IXAP332] ) . '"/>' . '<input type="hidden" name="attr-key-field" value="' . esc_attr( $IXAP332 ) . '"/>' . '</div>' . '<div class="field">' . '<label for="attr-value-field" class="field-label first required">' .__( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input id="attr-value-field" name="attr-value-field" class="attr-value-field" type="text" value="' . esc_attr( $IXAP342 ) . '"/>' . '</div>' . '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button" type="submit" value="' . __( 'Save', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="' . esc_attr( $IXAP38 ) . '" name="affiliate_id"/>' . '<input type="hidden" value="edit-attribute" name="action"/>' . '<a class="cancel" href="' . $IXAP331 . '">' . __( 'Cancel', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IXAP58; } function edit_submit() { global $wpdb, $affiliates_db, $IXAP1; $IXAP15 = true; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP94 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP38 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : null; $IXAP332 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : null; $IXAP333 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : null; if ( $IXAP333 !== null ) { $IXAP333 = Affiliates_Attributes::validate_value( $IXAP332, $IXAP333 ); if ( $IXAP333 !== false ) { if ( is_array( $IXAP333 ) || is_object( $IXAP333 ) ) { $IXAP333 = serialize( $IXAP333 ); } } else { $IXAP333 = null; } } $IXAP338 = false; if ( ( $IXAP332 == Affiliates_Attributes::IXAP82 ) && !empty( $IXAP333 ) ) { $IXAP339 = explode( ",", $IXAP333 ); foreach( $IXAP339 as $IXAP340 ) { $IXAP340 = trim( $IXAP340 ); $IXAP341 = self::get_affiliate_for_coupon( $IXAP340 ); if ( ( $IXAP341 !== null ) && ( $IXAP341 != $IXAP38 ) ) { $IXAP1[] = '<div class="error">' . sprintf( __( 'Coupons may not be assigned to multiple affiliates. The coupon code <strong>%s</strong> has already been assigned to the affiliate with Id %d.', AFFILIATES_PRO_PLUGIN_DOMAIN), $IXAP340, $IXAP341 ) . '</div>'; $IXAP338 = true; } } } if ( $IXAP338 ) { return false; } if ( !empty( $IXAP38 ) && Affiliates_Attributes::validate_key( $IXAP332 ) && ( $IXAP333 !== null ) ) { if ( $IXAP343 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP94 WHERE affiliate_id = %d AND attr_key = %s", $IXAP38, $IXAP332 ) ) { if ( $affiliates_db->query( "UPDATE $IXAP94 SET attr_value=%s WHERE affiliate_id=%d AND attr_key=%s", $IXAP333 , $IXAP38, $IXAP332 ) ) { do_action( 'affiliates_updated_attribute', $IXAP38, $IXAP332, $IXAP343, $IXAP333 ); } } else { $IXAP1[] = '<div class="error">' . __( 'Invalid key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP15 = false; } } else { $IXAP1[] = '<div class="error">' . __( 'Invalid data', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP15 = false; } return $IXAP15; } function remove( $IXAP38, $IXAP332 ) { global $affiliates_db; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } affiliates_pro_admin_notices(); $IXAP66 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP66 = remove_query_arg( 'action', $IXAP66 ); $IXAP66 = remove_query_arg( 'affiliate_id', $IXAP66 ); $IXAP331 = esc_url( $IXAP66 ) . "&action=edit&affiliate_id=" . urlencode( $IXAP38 ); $IXAP66 = remove_query_arg( 'paged', $IXAP66 ); $IXAP94 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP333 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP94 WHERE affiliate_id = %d AND attr_key = %s", $IXAP38, $IXAP332 ); $IXAP38 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : $IXAP38; $IXAP332 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : $IXAP332; $IXAP333 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : $IXAP333; $IXAP342 = @unserialize( $IXAP333 ); if ( $IXAP342 === false ) { $IXAP342 = $IXAP333; } if ( is_array( $IXAP342 ) ) { $IXAP342 = implode( "::", $IXAP342 ); } $IXAP254 = Affiliates_Attributes::get_keys(); $IXAP58 = '<div class="manage-affiliates">' . '<div>' . '<h2>' . __( 'Remove an attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h2>' . '</div>' . '<form id="remove-attribute" action="' . $IXAP66 . '" method="post">' . '<div class="affiliate-attribute remove">' . '<div class="field">' . '<label for="attr-key-field" class="field-label first required">' .__( 'Key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input readonly="readonly" id="attr-name-field" name="attr-name-field" class="attr-name-field" type="text" value="' . esc_attr( $IXAP254[$IXAP332] ) . '"/>' . '<input type="hidden" name="attr-key-field" value="' . esc_attr( $IXAP332 ) . '"/>' . '</div>' . '<div class="field">' . '<label for="attr-value-field" class="field-label first required">' .__( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input readonly="readonly" id="attr-value-field" name="attr-value-field" class="attr-value-field" type="text" value="' . esc_attr( $IXAP342 ) . '"/>' . '</div>' . '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button" type="submit" value="' . __( 'Remove', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="' . esc_attr( $IXAP38 ) . '" name="affiliate_id"/>' . '<input type="hidden" value="remove-attribute" name="action"/>' . '<a class="cancel" href="' . $IXAP331 . '">' . __( 'Cancel', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IXAP58; } function remove_submit() { global $wpdb, $affiliates_db, $IXAP1; $IXAP15 = true; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP94 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP38 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : null; $IXAP332 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : null; if ( !( empty( $IXAP38 ) || empty( $IXAP332 ) ) ) { $IXAP333 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP94 WHERE affiliate_id = %d AND attr_key = %s", $IXAP38, $IXAP332 ); if ( $affiliates_db->query( "DELETE FROM $IXAP94 WHERE affiliate_id=%d AND attr_key=%s", $IXAP38, $IXAP332 ) ) { do_action( 'affiliates_removed_attribute', $IXAP38, $IXAP332, $IXAP333 ); } } else { $IXAP15 = false; } return $IXAP15; } public static function get_affiliate_for_coupon( $IXAP340 ) { global $affiliates_db; $IXAP94 = $affiliates_db->get_tablename( "affiliates_attributes" ); $IXAP344 = $affiliates_db->get_objects( "SELECT * FROM $IXAP94 WHERE attr_key = %s AND attr_value LIKE '%%%s%%'", Affiliates_Attributes::IXAP82, $IXAP340 ); $IXAP38 = null; foreach( $IXAP344 as $IXAP345 ) { $IXAP346 = explode( ",", $IXAP345->attr_value ); foreach( $IXAP346 as $IXAP347 ) { $IXAP347 = trim( $IXAP347 ); if ( $IXAP347 === $IXAP340 ) { $IXAP38 = $IXAP345->affiliate_id; break; } } if ( $IXAP38 !== null ) { break; } } return apply_filters( 'affiliates_coupon_affiliate_id', $IXAP38, $IXAP340 ); } public static function get_coupons_for_affiliate( $IXAP38 ) { global $affiliates_db; $IXAP15 = array(); $IXAP94 = $affiliates_db->get_tablename( 'affiliates_attributes' ); if ( $IXAP339 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP94 WHERE affiliate_id = %d AND attr_key = %s", intval( $IXAP38 ), Affiliates_Attributes::IXAP82 ) ) { $IXAP15 = explode( ',', $IXAP339 ); } return $IXAP15; } public static function set_coupons_for_affiliate( $IXAP38, $IXAP339 = array() ) { global $affiliates_db; $IXAP38 = intval( $IXAP38 ); $IXAP348 = array(); foreach( $IXAP339 as $IXAP340 ) { $IXAP340 = trim( $IXAP340 ); if ( strlen( $IXAP340 ) > 0 ) { $IXAP341 = self::get_affiliate_for_coupon( $IXAP340 ); if ( ( $IXAP341 === null ) || ( $IXAP341 == $IXAP38 ) ) { $IXAP348[] = $IXAP340; } } } $IXAP339 = $IXAP348; $IXAP349 = self::get_coupons_for_affiliate( $IXAP38 ); if ( $IXAP349 != $IXAP339 ) { $IXAP94 = $affiliates_db->get_tablename( 'affiliates_attributes' ); if ( count( $IXAP339 ) == 0 ) { if ( $affiliates_db->query( "DELETE FROM $IXAP94 WHERE affiliate_id=%d AND attr_key=%s", $IXAP38, $IXAP332 ) ) { do_action( 'affiliates_removed_attribute', $IXAP38, Affiliates_Attributes::IXAP82, implode( ',', $IXAP349 ) ); } } else { if ( $IXAP343 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP94 WHERE affiliate_id = %d AND attr_key = %s", $IXAP38, Affiliates_Attributes::IXAP82 ) ) { if ( $affiliates_db->query( "UPDATE $IXAP94 SET attr_value=%s WHERE affiliate_id=%d AND attr_key=%s", implode( ',', $IXAP339 ) , $IXAP38, Affiliates_Attributes::IXAP82 ) ) { do_action( 'affiliates_updated_attribute', $IXAP38, Affiliates_Attributes::IXAP82, $IXAP343, implode( ',', $IXAP339 ) ); } } else { if ( $affiliates_db->query( "INSERT INTO $IXAP94 SET affiliate_id=%d, attr_key=%s, attr_value=%s", $IXAP38, Affiliates_Attributes::IXAP82, implode( ',', $IXAP339 ) ) ) { do_action( 'affiliates_added_attribute', $IXAP38, Affiliates_Attributes::IXAP82, implode( ',', $IXAP339 ) ); } } } } } } 