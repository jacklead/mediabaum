<?php
 class Affiliates_Affiliate_Stats_Renderer_WordPress extends Affiliates_Affiliate_Stats_Renderer { const IXAP174 = 'affiliate-stats-nonce'; const IXAP175 = 'affiliate-stats-nonce-1'; const IXAP176 = 'affiliate-stats-nonce-2'; const IXAP177 = 'affiliate-stats-nonce-filters'; static function render_referrals( $IXAP101 = array() ) { global $wpdb, $affiliates_options, $affiliates_db; $IXAP58 = ''; $IXAP38 = Affiliates_Affiliate_WordPress::get_user_affiliate_id(); if ( $IXAP38 === false ) { return $IXAP58; } $IXAP31 = $affiliates_options->get_option( 'affiliate_stats_referrals_from_date', null ); $IXAP33 = $affiliates_options->get_option( 'affiliate_stats_referrals_thru_date', null ); if ( isset( $_POST[self::IXAP177] ) ) { if ( !wp_verify_nonce( $_POST[self::IXAP177], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( isset( $_POST['clear_filters'] ) ) { $affiliates_options->delete_option( 'affiliate_stats_referrals_from_date' ); $affiliates_options->delete_option( 'affiliate_stats_referrals_thru_date' ); $IXAP31 = null; $IXAP33 = null; } else { if ( !empty( $_POST['from_date'] ) ) { $IXAP31 = date( 'Y-m-d', strtotime( $_POST['from_date'] ) ); $affiliates_options->update_option( 'affiliate_stats_referrals_from_date', $IXAP31 ); } if ( !empty( $_POST['thru_date'] ) ) { $IXAP33 = date( 'Y-m-d', strtotime( $_POST['thru_date'] ) ); $affiliates_options->update_option( 'affiliate_stats_referrals_thru_date', $IXAP33 ); } if ( $IXAP31 && $IXAP33 ) { if ( strtotime( $IXAP31 ) > strtotime( $IXAP33 ) ) { $IXAP33 = null; $affiliates_options->delete_option( 'affiliate_stats_referrals_thru_date' ); } } } } if ( $IXAP31 ) { $IXAP32 = DateHelper::u2s( $IXAP31 ); } if ( $IXAP33 ) { $IXAP34 = DateHelper::u2s( $IXAP33, 24*3600 ); } if ( isset( $_POST['row_count'] ) ) { if ( !wp_verify_nonce( $_POST[self::IXAP175], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } } if ( isset( $_POST['paged'] ) ) { if ( !wp_verify_nonce( $_POST[self::IXAP176], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } } $IXAP66 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP66 = remove_query_arg( 'paged', $IXAP66 ); $IXAP43 = $affiliates_db->get_tablename( 'affiliates' ); $IXAP45 = $affiliates_db->get_tablename( 'referrals' ); $IXAP108 = $affiliates_db->get_tablename( 'hits' ); $posts_table = $wpdb->prefix . 'posts'; $IXAP178 = isset( $_POST['row_count'] ) ? intval( $_POST['row_count'] ) : 0; if ($IXAP178 <= 0) { $IXAP178 = $affiliates_options->get_option( 'affiliate_stats_referrals_per_page', self::IXAP179 ); } else { $affiliates_options->update_option( 'affiliate_stats_referrals_per_page', $IXAP178 ); } $IXAP180 = isset( $_GET['offset'] ) ? intval( $_GET['offset'] ) : 0; if ( $IXAP180 < 0 ) { $IXAP180 = 0; } $IXAP181 = isset( $_GET['paged'] ) ? intval( $_GET['paged'] ) : 0; if ( !isset( $_GET['paged'] ) ) { $IXAP181 = intval( get_query_var( 'paged' ) ); } if ( $IXAP181 < 0 ) { $IXAP181 = 0; } $IXAP41 = isset( $_GET['orderby'] ) ? $_GET['orderby'] : null; switch ( $IXAP41 ) { case 'datetime' : case 'post_title' : case 'amount' : case 'currency_id' : case 'status' : break; default : $IXAP41 = 'datetime'; } $IXAP42 = isset( $_GET['order'] ) ? $_GET['order'] : null; switch ( $IXAP42 ) { case 'asc' : case 'ASC' : $IXAP182 = 'DESC'; break; case 'desc' : case 'DESC' : $IXAP182 = 'ASC'; break; default: $IXAP42 = 'DESC'; $IXAP182 = 'ASC'; } if ( $IXAP31 || $IXAP33 || $IXAP38 ) { $IXAP47 = " WHERE "; } else { $IXAP47 = ''; } $IXAP48 = array(); if ( $IXAP31 && $IXAP33 ) { $IXAP47 .= " datetime >= %s AND datetime < %s "; $IXAP48[] = $IXAP32; $IXAP48[] = $IXAP34; } else if ( $IXAP31 ) { $IXAP47 .= " datetime >= %s "; $IXAP48[] = $IXAP32; } else if ( $IXAP33 ) { $IXAP47 .= " datetime < %s "; $IXAP48[] = $IXAP34; } if ( $IXAP38 ) { if ( $IXAP31 || $IXAP33 ) { $IXAP47 .= " AND "; } $IXAP47 .= " r.affiliate_id = %d "; $IXAP48[] = $IXAP38; } $IXAP183 = isset( $IXAP101['show_accepted'] ) && ( ( $IXAP101['show_accepted'] === true ) || ( $IXAP101['show_accepted'] == 'true' ) ); $IXAP184 = isset( $IXAP101['show_pending'] ) && ( ( $IXAP101['show_pending'] === true ) || ( $IXAP101['show_pending'] == 'true' ) ); $IXAP185 = isset( $IXAP101['show_closed'] ) && ( ( $IXAP101['show_closed'] === true ) || ( $IXAP101['show_closed'] == 'true' ) ); $IXAP186 = isset( $IXAP101['show_rejected'] ) && ( ( $IXAP101['show_rejected'] === true ) || ( $IXAP101['show_rejected'] == 'true' ) ); $IXAP187 = 0; if ( $IXAP183 ) { $IXAP187++; $IXAP48[] = AFFILIATES_REFERRAL_STATUS_ACCEPTED; } if ( $IXAP184 ) { $IXAP187++; $IXAP48[] = AFFILIATES_REFERRAL_STATUS_PENDING; } if ( $IXAP185 ) { $IXAP187++; $IXAP48[] = AFFILIATES_REFERRAL_STATUS_CLOSED; } if ( $IXAP186 ) { $IXAP187++; $IXAP48[] = AFFILIATES_REFERRAL_STATUS_REJECTED; } if ( $IXAP31 || $IXAP33 || $IXAP38 ) { $IXAP47 .= " AND "; } switch ( $IXAP187 ) { case 1 : $IXAP47 .= " r.status = %s "; break; case 2 : $IXAP47 .= " r.status IN ( %s, %s ) "; break; case 3 : $IXAP47 .= " r.status IN ( %s, %s, %s ) "; break; case 4 : $IXAP47 .= " r.status IN ( %s, %s, %s, %s ) "; break; default : $IXAP47 .= " r.status = '' "; } $IXAP188 = $wpdb->prepare( "SELECT count(*) FROM $IXAP45 r
			$IXAP47
			", $IXAP48 ); $IXAP189 = $wpdb->get_var( $IXAP188 ); if ( $IXAP189 > $IXAP178 ) { $IXAP190 = true; } else { $IXAP190 = false; } $IXAP18 = ceil ( $IXAP189 / $IXAP178 ); if ( $IXAP181 > $IXAP18 ) { $IXAP181 = $IXAP18; } if ( $IXAP181 != 0 ) { $IXAP180 = ( $IXAP181 - 1 ) * $IXAP178; } $IXAP95 = $wpdb->prepare("
			SELECT r.*
			FROM $IXAP45 r
			LEFT JOIN $IXAP43 a ON r.affiliate_id = a.affiliate_id
			LEFT JOIN $posts_table p ON r.post_id = p.ID
			$IXAP47
			ORDER BY $IXAP41 $IXAP42
			LIMIT $IXAP178 OFFSET $IXAP180
			", $IXAP48 ); $IXAP51 = $wpdb->get_results( $IXAP95, OBJECT ); $IXAP58 .= '<div class="affiliate-stats referrals">'; $IXAP58 .= '
			<div class="page-options">
				<form id="setrowcount" action="" method="post">
					<div>
						<label for="row_count">' . __('Results per page', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input name="row_count" type="text" size="2" value="' . esc_attr( $IXAP178 ) .'" />
						' . wp_nonce_field( plugin_basename( __FILE__ ), self::IXAP175, true, false ) . '
						<input type="submit" value="' . __( 'Apply', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>
					</div>
				</form>
			</div>
			'; if ( $IXAP190 ) { $IXAP191 = new Affiliates_Pagination( $IXAP189, null, $IXAP178 ); $IXAP58 .= '<form id="posts-filter" method="post" action="">'; $IXAP58 .= '<div>'; $IXAP58 .= wp_nonce_field( plugin_basename( __FILE__ ), self::IXAP176, true, false ); $IXAP58 .= '</div>'; $IXAP58 .= '<div class="tablenav top">'; $IXAP58 .= $IXAP191->pagination( 'top' ); $IXAP58 .= '</div>'; $IXAP58 .= '</form>'; } $IXAP192 = isset( $IXAP101['show_post'] ) && ( ( $IXAP101['show_post'] === true ) || ( $IXAP101['show_post'] == 'true' ) ); $IXAP72 = array( 'datetime' => __( 'Date', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); if ( $IXAP192 ) { $IXAP72['post_title'] = __( 'Post', AFFILIATES_PRO_PLUGIN_DOMAIN ); } $IXAP193 = isset( $IXAP101['show_amount'] ) && ( ( $IXAP101['show_amount'] === true ) || ( $IXAP101['show_amount'] == 'true' ) ); if ( $IXAP193 ) { $IXAP72['amount'] = __( 'Amount', AFFILIATES_PRO_PLUGIN_DOMAIN ); } $IXAP194 = isset( $IXAP101['show_currency_id'] ) && ( ( $IXAP101['show_currency_id'] === true ) || ( $IXAP101['show_currency_id'] == 'true' ) ); if ( $IXAP194 ) { $IXAP72['currency_id'] = __( 'Currency', AFFILIATES_PRO_PLUGIN_DOMAIN ); } $IXAP195 = isset( $IXAP101['show_status'] ) && ( ( $IXAP101['show_status'] === true ) || ( $IXAP101['show_status'] == 'true' ) ); if ( $IXAP195 ) { $IXAP72['status'] = __( 'Status', AFFILIATES_PRO_PLUGIN_DOMAIN ); } if ( !empty( $IXAP101['data'] ) ) { $IXAP72['data'] = __( 'Details', AFFILIATES_PRO_PLUGIN_DOMAIN ); } $IXAP196 = count( $IXAP72 ); $IXAP58 .= '
			<table class="referrals" cellspacing="0" cellpadding="0">
			<thead>
				<tr>
				'; foreach ( $IXAP72 as $IXAP74 => $IXAP75 ) { $IXAP197 = array( 'orderby' => $IXAP74, 'order' => $IXAP182 ); if ( $IXAP74 != 'data') { $IXAP139 = ""; if ( strcmp( $IXAP74, $IXAP41 ) == 0 ) { $IXAP198 = strtolower( $IXAP42 ); $IXAP139 = "$IXAP74 manage-column sorted $IXAP198"; } else { $IXAP139 = "$IXAP74 manage-column sortable"; } $IXAP75 = '<a href="' . esc_url( add_query_arg( $IXAP197, $IXAP66 ) ) . '"><span>' . $IXAP75 . '</span><span class="sorting-indicator"></span></a>'; $IXAP58 .= "<th scope='col' class='$IXAP139'>$IXAP75</th>"; } else { $IXAP58 .= "<th scope='col' class='$IXAP74'>$IXAP75</th>"; } } $IXAP58 .= '</tr>
			</thead>
			<tbody>
			'; if ( count( $IXAP51 ) > 0 ) { $IXAP199 = array(); if ( !empty( $IXAP101['data'] ) ) { $IXAP200 = explode(",", $IXAP101['data'] ); if ( !empty( $IXAP200 ) ) { foreach( $IXAP200 as $IXAP201 ) { $IXAP199[] = trim( $IXAP201 ); } } } $IXAP71 = array( AFFILIATES_REFERRAL_STATUS_ACCEPTED => __( 'Accepted', AFFILIATES_PLUGIN_DOMAIN ), AFFILIATES_REFERRAL_STATUS_CLOSED => __( 'Closed', AFFILIATES_PLUGIN_DOMAIN ), AFFILIATES_REFERRAL_STATUS_PENDING => __( 'Pending', AFFILIATES_PLUGIN_DOMAIN ), AFFILIATES_REFERRAL_STATUS_REJECTED => __( 'Rejected', AFFILIATES_PLUGIN_DOMAIN ), ); for ( $IXAP76 = 0; $IXAP76 < count( $IXAP51 ); $IXAP76++ ) { $IXAP15 = $IXAP51[$IXAP76]; $IXAP58 .= '<tr class="details-referrals ' . ( $IXAP76 % 2 == 0 ? 'even' : 'odd' ) . '">'; $IXAP58 .= '<td class="datetime">' . DateHelper::s2u( $IXAP15->datetime ) . '</td>'; if ( $IXAP192 ) { if ( !empty( $IXAP15->post_id ) ) { $IXAP202 = get_permalink( $IXAP15->post_id ); $post_title = get_the_title( $IXAP15->post_id ); $IXAP58 .= '<td class="post_title"><a href="' . esc_attr( $IXAP202 ) . '" target="_blank">' . wp_filter_nohtml_kses( $post_title ) . '</a></td>'; } else { $IXAP58 .= '<td class="post_title"></td>'; } } if ( $IXAP193 ) { $IXAP58 .= '<td class="amount">' . esc_attr( $IXAP15->amount ) . '</td>'; } if ( $IXAP194 ) { $IXAP58 .= '<td class="currency_id">' . esc_attr( $IXAP15->currency_id ) . '</td>'; } if ( $IXAP195 ) { $IXAP58 .= '<td class="status">' . ( isset( $IXAP71[$IXAP15->status] ) ? $IXAP71[$IXAP15->status] : esc_attr( $IXAP15->status ) ) . '</td>'; } if ( !empty( $IXAP199 ) ) { $IXAP203 = $IXAP15->data; if ( !empty( $IXAP203 ) ) { $IXAP203 = unserialize( $IXAP203 ); if ( $IXAP203 ) { $IXAP58 .= "<td>"; if ( is_array( $IXAP203 ) ) { foreach ( $IXAP199 as $IXAP74 ) { $IXAP204 = $IXAP203[$IXAP74]; $IXAP77 = __( $IXAP204['title'], $IXAP204['domain'] ); $IXAP83 = $IXAP204['value']; $IXAP58 .= '<div class="referral-data-title">'; $IXAP58 .= stripslashes( wp_filter_nohtml_kses( $IXAP77 ) ); $IXAP58 .= '</div>'; $IXAP58 .= '<div class="referral-data-value">'; $IXAP58 .= stripslashes( wp_filter_nohtml_kses( $IXAP83 ) ); $IXAP58 .= '</div>'; } } else { if ( !empty( $IXAP199 ) && ( $IXAP199[0] == 'data' ) ) { $IXAP58 .= '<div class="referral-data-value">'; $IXAP58 .= stripslashes( wp_filter_nohtml_kses( $IXAP203 ) ); $IXAP58 .= '</div>'; } } $IXAP58 .= '</td>'; } } } $IXAP58 .= '</tr>'; } } else { $IXAP58 .= '<tr><td colspan="' . $IXAP196 . '">' . __('There are no results.', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</td></tr>'; } $IXAP58 .= '</tbody>'; $IXAP58 .= '</table>'; if ( $IXAP190 ) { $IXAP191 = new Affiliates_Pagination( $IXAP189, null, $IXAP178 ); $IXAP58 .= '<div class="tablenav bottom">'; $IXAP58 .= $IXAP191->pagination( 'bottom' ); $IXAP58 .= '</div>'; } $IXAP58 .= '<div class="filters">' . '<label class="description" for="setfilters">' . __( 'Filters', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<form id="setfilters" action="" method="post">' . '<div class="from-date">' . '<label class="from-date-filter" for="from_date">' . __('From', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input class="datefield from-date-filter" name="from_date" type="text" value="' . esc_attr( $IXAP31 ) . '"/>'. '</div>' . '<div class="thru-date">' . '<label class="thru-date-filter" for="thru_date">' . __('Until', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input class="datefield thru-date-filter" name="thru_date" type="text" class="datefield" value="' . esc_attr( $IXAP33 ) . '"/>'. '</div>' . '<div class="submit">' . wp_nonce_field( plugin_basename( __FILE__ ), self::IXAP177, true, false ) . '<input type="submit" value="' . __( 'Apply', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="submit" name="clear_filters" value="' . __( 'Clear', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="submitted" name="submitted"/>' . '</div>' . '</form>' . '</div>'; $IXAP58 .= '</div>'; return $IXAP58; } } 