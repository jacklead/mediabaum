<?php
 class Affiliates_Notifications { const IXAP425 = 'affiliates_notifications'; const IXAP292 = 'registration_enabled'; const IXAP314 = true; const IXAP293 = 'registration_subject'; const IXAP295 = 'registration_message'; const IXAP294 = '[site_title] Your username and password'; const IXAP296 = 'Username: [username]<br/>
Password: [password]<br/>
[site_login_url]<br/>'; const IXAP297 = 'enabled'; const IXAP298 = 'notify_admin'; const IXAP299 = 'notify_admin_email'; const IXAP302 = 'notify_admin_status'; const IXAP303 = 'admin_subject'; const IXAP305 = 'admin_message'; const IXAP304 = 'Referral'; const IXAP306 = 'A referral has been credited to the affiliate [affiliate_name] (ID [affiliate_id]) on <a href="[site_url]">[site_title]</a>.<br/>'; const IXAP307 = 'notify_affiliate'; const IXAP309 = 'notify_affiliate_status'; const IXAP310 = 'subject'; const MESSAGE = 'message'; const IXAP311 = 'Referral'; const IXAP312 = 'Hi [affiliate_name],<br/>
A referral has been credited to you on <a href="[site_url]">[site_title]</a>.<br/>
<br/>
Greetings,<br/>
[site_title]<br/>
[site_url]
'; public static function init() { add_filter( 'pre_option_aff_notify_affiliate_user', array( __CLASS__, 'pre_option_aff_notify_affiliate_user' ) ); add_filter( 'affiliates_new_affiliate_user_registration_subject', array( __CLASS__, 'affiliates_new_affiliate_user_registration_subject' ), 10, 2 ); add_filter( 'affiliates_new_affiliate_user_registration_message', array( __CLASS__, 'affiliates_new_affiliate_user_registration_message' ), 10, 2 ); add_filter( 'affiliates_new_affiliate_user_registration_headers', array( __CLASS__, 'affiliates_new_affiliate_user_registration_headers' ), 10, 2 ); $IXAP291 = get_option( 'affiliates_notifications', array() ); if ( !empty( $IXAP291['enabled'] ) && $IXAP291['enabled'] ) { add_action( 'affiliates_referral', array( __CLASS__, 'affiliates_referral' ) ); add_action( 'affiliates_updated_referral', array( __CLASS__, 'affiliates_updated_referral' ), 10, 4 ); } } public static function pre_option_aff_notify_affiliate_user( $IXAP83 ) { $IXAP291 = get_option( 'affiliates_notifications', array() ); $IXAP313 = isset( $IXAP291[Affiliates_Notifications::IXAP292] ) ? $IXAP291[Affiliates_Notifications::IXAP292] : Affiliates_Notifications::IXAP314; if ( $IXAP313 ) { $IXAP83 = 'yes'; } else { $IXAP83 = 'no'; } return $IXAP83; } public static function affiliates_new_affiliate_user_registration_subject( $IXAP322, $IXAP30 ) { $IXAP291 = get_option( 'affiliates_notifications', array() ); $IXAP315 = isset( $IXAP291[Affiliates_Notifications::IXAP293] ) ? $IXAP291[Affiliates_Notifications::IXAP293] : Affiliates_Notifications::IXAP294; $IXAP426 = self::get_registration_tokens( $IXAP30 ); $IXAP322 = self::substitute_tokens( stripslashes( $IXAP315 ), $IXAP426 ); return $IXAP322; } public static function affiliates_new_affiliate_user_registration_message( $message, $IXAP30 ) { $IXAP291 = get_option( 'affiliates_notifications', array() ); $IXAP316 = isset( $IXAP291[Affiliates_Notifications::IXAP295] ) ? $IXAP291[Affiliates_Notifications::IXAP295] : Affiliates_Notifications::IXAP296; $IXAP426 = self::get_registration_tokens( $IXAP30 ); $message = self::substitute_tokens( stripslashes( $IXAP316 ), $IXAP426 ); return $message; } public static function affiliates_new_affiliate_user_registration_headers( $IXAP427 = '', $IXAP30 = array() ) { $IXAP427 .= 'Content-type: text/html; charset="' . get_option( 'blog_charset' ) . '"' . "\r\n"; return $IXAP427; } private static function get_registration_tokens( $IXAP30 ) { $IXAP426 = array(); foreach( $IXAP30 as $IXAP74 => $IXAP83 ) { if ( is_string( $IXAP83 ) ) { $IXAP426[$IXAP74] = $IXAP83; } } $IXAP426['site_title'] = wp_specialchars_decode( get_bloginfo( 'blogname' ), ENT_QUOTES ); $IXAP426['site_url'] = get_bloginfo( 'url' ); $IXAP426 = apply_filters( 'affiliates_registration_tokens', $IXAP426 ); return $IXAP426; } private static function substitute_tokens( $IXAP70, $IXAP426 ) { foreach ( $IXAP426 as $IXAP74 => $IXAP83 ) { if ( key_exists( $IXAP74, $IXAP426 ) ) { $IXAP428 = $IXAP426[$IXAP74]; $IXAP70 = str_replace( "[" . $IXAP74 . "]", $IXAP428, $IXAP70 ); } } return $IXAP70; } public static function affiliates_referral( $IXAP257 ) { global $affiliates_db; $IXAP45 = $affiliates_db->get_tablename( 'referrals' ); if ( $IXAP207 = $affiliates_db->get_objects( "SELECT * FROM $IXAP45 WHERE referral_id = %d", intval( $IXAP257 ) ) ) { if ( isset( $IXAP207[0] ) ) { $IXAP166 = $IXAP207[0]; if ( $IXAP328 = affiliates_get_affiliate( $IXAP166->affiliate_id ) ) { $IXAP291 = get_option( 'affiliates_notifications', array() ); $IXAP318 = isset( $IXAP291[self::IXAP298] ) ? $IXAP291[self::IXAP298] : false; $IXAP300 = isset( $IXAP291[self::IXAP299] ) ? $IXAP291[self::IXAP299] : ''; $IXAP321 = isset( $IXAP291[self::IXAP307] ) ? $IXAP291[self::IXAP307] : false; if ( $IXAP318 || $IXAP321 ) { require_once( dirname( AFFILIATES_PRO_FILE ) . '/lib/ext/includes/class-affiliates-mail.php' ); $IXAP429 = new Affiliates_Mail(); $IXAP429->mailer = 'wp_mail'; $IXAP429->charset = get_option( 'blog_charset' ); $IXAP430 = wp_specialchars_decode( get_bloginfo( 'blogname' ), ENT_QUOTES ); $IXAP431 = get_bloginfo( 'url' ); $IXAP426 = apply_filters( 'affiliates_notifications_tokens', array( 'site_title' => $IXAP430, 'site_url' => $IXAP431, 'affiliate_name' => wp_filter_nohtml_kses( $IXAP328['name'] ), 'affiliate_id' => $IXAP328['affiliate_id'], 'affiliate_email' => $IXAP328['email'], 'referral_status' => $IXAP166->status, 'referral_id' => $IXAP166->referral_id, 'referral_amount' => $IXAP166->amount, 'referral_currency_id' => $IXAP166->currency_id, 'referral_type' => $IXAP166->type, 'referral_reference' => $IXAP166->reference ) ); $IXAP432 = array(); $IXAP203 = array(); if ( !empty( $IXAP166->data ) ) { $IXAP203 = unserialize( $IXAP166->data ); if ( $IXAP203 && is_array( $IXAP203 ) ) { $IXAP432 = array_keys( $IXAP203 ); } } $IXAP432 = apply_filters( 'affiliates_notifications_data_tokens', $IXAP432, $IXAP426 ); $IXAP203 = apply_filters( 'affiliates_notifications_data', $IXAP203, $IXAP432, $IXAP426 ); if ( $IXAP318 ) { $IXAP433 = empty( $IXAP300 ) ? get_bloginfo( 'admin_email' ) : $IXAP300; if ( !empty( $IXAP433 ) ) { $IXAP301 = isset( $IXAP291[Affiliates_Notifications::IXAP302] ) ? $IXAP291[Affiliates_Notifications::IXAP302] : array( AFFILIATES_REFERRAL_STATUS_ACCEPTED ); if ( in_array( $IXAP166->status, $IXAP301 ) ) { $IXAP319 = isset( $IXAP291[self::IXAP303] ) ? $IXAP291[self::IXAP303] : self::IXAP304; $IXAP320 = isset( $IXAP291[self::IXAP305] ) ? $IXAP291[self::IXAP305] : self::IXAP306; $IXAP429->mail( $IXAP433, stripslashes( wp_filter_nohtml_kses( $IXAP319 ) ), stripslashes( wp_filter_post_kses( $IXAP320 ) ), $IXAP426, $IXAP432, $IXAP203 ); } } } if ( $IXAP321 ) { if ( !empty( $IXAP328['email'] ) ) { $IXAP308 = isset( $IXAP291[Affiliates_Notifications::IXAP309] ) ? $IXAP291[Affiliates_Notifications::IXAP309] : array( AFFILIATES_REFERRAL_STATUS_ACCEPTED ); if ( in_array( $IXAP166->status, $IXAP308 ) ) { $IXAP322 = isset( $IXAP291[self::IXAP310] ) ? $IXAP291[self::IXAP310] : self::IXAP311; $message = isset( $IXAP291[self::MESSAGE] ) ? $IXAP291[self::MESSAGE] : self::IXAP312; $IXAP429->mail( $IXAP328['email'], stripslashes( wp_filter_nohtml_kses( $IXAP322 ) ), stripslashes( wp_filter_post_kses( $message ) ), $IXAP426, $IXAP432, $IXAP203 ); } } } } } } } } public static function affiliates_updated_referral( $IXAP257, $IXAP254, $IXAP86, $IXAP260 ) { $IXAP25 = count( $IXAP254 ); for( $IXAP76 = 0; $IXAP76 < $IXAP25; $IXAP76++ ) { if ( $IXAP254[$IXAP76] == 'status' ) { $IXAP57 = $IXAP86[$IXAP76]; $IXAP434 = $IXAP260[$IXAP76]; if ( ( $IXAP57 == AFFILIATES_REFERRAL_STATUS_ACCEPTED ) && ( $IXAP434 == AFFILIATES_REFERRAL_STATUS_PENDING ) ) { self::affiliates_referral( $IXAP257 ); } } } } } add_action( 'init', array( 'Affiliates_Notifications', 'init' ) ); 